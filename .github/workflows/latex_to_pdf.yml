name: Compile LaTeX to PDF

# Déclenche le workflow à chaque 'push' sur la branche 'main' et manuellement
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_latex:
    runs-on: ubuntu-latest
    
    steps:
      # Étape 1 : Récupérer le code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Étape 2 : Créer le dossier de destination pour les PDF finaux
      - name: Setup docs directory
        run: |
          mkdir -p docs/pdf
          touch docs/.nojekyll
          
      # Étape 3 : Trouver et compiler chaque fichier .tex individuellement
      # Cette étape compile un par un et place le PDF à côté du .tex, 
      # ce qui est nécessaire avant de les déplacer.
      - name: Compile all .tex files (excluding build directories)
        run: |
          # Installation de TexLive complète pour toutes les dépendances
          sudo apt-get install -y texlive-full
          
          # Boucle sur tous les fichiers .tex trouvés, en ignorant le contenu des dossiers 'build'
          find . -type f -name "*.tex" -not -path "*/build/*" | while read TEX_FILE; do
            # Définir le répertoire de travail pour la compilation
            DIR=$(dirname "$TEX_FILE")
            FILENAME=$(basename "$TEX_FILE" .tex)

            echo "Compiling $TEX_FILE..."
            
            # Aller dans le répertoire pour que pdflatex trouve les éventuelles images/styles
            cd "$DIR"
            
            # Compiler avec pdflatex (3 passes pour références/sommaire)
            pdflatex --shell-escape -interaction=nonstopmode "$FILENAME.tex"
            pdflatex --shell-escape -interaction=nonstopmode "$FILENAME.tex"
            pdflatex --shell-escape -interaction=nonstopmode "$FILENAME.tex"
            
            # Revenir à la racine du dépôt pour le prochain fichier
            cd "$GITHUB_WORKSPACE"
            
            # Déplacer le PDF fini vers le dossier de publication
            mv "$DIR/$FILENAME.pdf" "docs/pdf/$FILENAME.pdf"
          done

      # Étape 4 : Téléverser les PDF générés comme Artéfacts (facultatif, pour le téléchargement)
      - name: Upload PDF artifacts
        uses: actions/upload-artifact@v4
        with:
          name: compiled-pdfs
          path: docs/pdf/